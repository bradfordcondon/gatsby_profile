{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2019-03-19_migrating_chado_onetwo_to_onethree/","result":{"data":{"markdownRemark":{"html":"<p>This post is a simple guide for navigating some of the problems one might encounter using the <a href=\"tripal.info\">Tripal</a> Chado 1.2 to 1.3 migration script.</p>\n<h1>executive summary</h1>\n<ul>\n<li>preparation of database by dropping views (see shell script below)\n<ul>\n<li>Create drop script</li>\n<li>run drop script</li>\n</ul>\n</li>\n<li>Submit upgrade job at <code class=\"language-text\">/admin/tripal/storage/chado/install</code></li>\n<li>If size error: resize disk if possible</li>\n<li>If still size error: uncomment transaction in install file</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">touch</span> generate_drop_file.sql\n<span class=\"token comment\"># copy the drop script in the \"dropping views section\" into said file</span>\ndrush sql-query --file<span class=\"token operator\">=</span>generate_drop_file.sql --result-file<span class=\"token operator\">=</span>drop_script.sql\ndrush sql-query --file<span class=\"token operator\">=</span>drop_script.sql\ndrush sql-query <span class=\"token string\">\"DROP TABLE IF EXISTS chado.all_feature_names CASCADE;\"</span>\n</code></pre></div>\n<h1>details</h1>\n<p>Tripal has a GUI to run the Chado 1.2 to 1.3 migration.  However, it doesn't run smoothly on many sites.  There are three main reasons for this:</p>\n<ul>\n<li>Your site has views Tripal didn't expect</li>\n<li>Your site has some views as tables instead</li>\n<li>The database transaction requires more disk space than your site has free</li>\n</ul>\n<h3>dropping views</h3>\n<p>The first thing to do is create a drop script.  The below SQL will output an SQL script that will drop all the chado and so (sequence ontology) views from your site (something the migration script attempts to do at the start.)</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">set</span> search_path<span class=\"token operator\">=</span><span class=\"token keyword\">public</span><span class=\"token punctuation\">,</span>so<span class=\"token punctuation\">,</span>frange<span class=\"token punctuation\">,</span>genetic_code<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token string\">'drop view \"'</span> <span class=\"token operator\">||</span> viewname <span class=\"token operator\">||</span> <span class=\"token string\">'\" cascade;'</span>\n<span class=\"token keyword\">from</span> pg_views <span class=\"token keyword\">where</span> schemaname <span class=\"token operator\">=</span> <span class=\"token string\">'so'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">select</span> <span class=\"token string\">'drop view \"'</span> <span class=\"token operator\">||</span> viewname <span class=\"token operator\">||</span> <span class=\"token string\">'\" cascade;'</span>\n<span class=\"token keyword\">from</span> pg_views <span class=\"token keyword\">where</span> schemaname <span class=\"token operator\">=</span> <span class=\"token string\">'chado'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We can use drush to generate the drop query like so: <code class=\"language-text\">drush sql-query  --file generate_drop_file.sql result-file drop_script.sql</code> where <code class=\"language-text\">generate_drop_file</code> is our input drop script above.</p>\n<p>Once you've generated the drop script, you should run it.  All together it will look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">\ndrush sql-query --file<span class=\"token operator\">=</span>generate_drop_file.sql --result-file<span class=\"token operator\">=</span>drop_script.sql\ndrush sql-query --file<span class=\"token operator\">=</span>drop_script.sql\n</code></pre></div>\n<h2>dropping tables that SHOULD be views</h2>\n<p>Oddly enough the <code class=\"language-text\">chado.all_feature_names</code> table is SUPPOSED to be a view according to the Chado documentation.  We therefore need to drop it, otherwise the script will complain when it tries to drop the view!</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">set</span> search_path<span class=\"token operator\">=</span>chado<span class=\"token punctuation\">;</span>\n <span class=\"token keyword\">DROP</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">IF</span> <span class=\"token keyword\">EXISTS</span> all_feature_names <span class=\"token keyword\">CASCADE</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Disabling the transaction</h2>\n<p>You are now ready to try running the migration!  It's located at<code class=\"language-text\">/admin/tripal/storage/chado/install</code>.  You should see 1.2 as the currently installed version- select \"upgrade existing Chado v1.2 to v1.3 (no data is lost)\".  You will see lots of warnings/notices informing you about what this ugpgrade will.  Notably, you should plan on <strong>redefining any custom materialized views</strong> after running the migration to hold big integers instead of integers.</p>\n<p>If you run the migration and get the bellow error, you have run out of space!</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Disk full: 7 ERROR:  could not extend file \"base/40960/269560.3\": No space left on deviceHINT:  Check free disk space.:ALTER TABLE feature     ALTER feature_id TYPE  bigint,    ALTER dbxref_id TYPE bigint,    ALTER organism_id TYPE bigint,    ALTER seqlen TYPE bigint,    ALTER type_id TYPE bigint;\n</code></pre></div>\n<p>You have two strategies to overcome this:</p>\n<ol>\n<li>Increase your disk space</li>\n<li>Disable the transaction in the code</li>\n</ol>\n<p>If 1) doesnt work or isn't possible, just comment out the transaction in the <code class=\"language-text\">tripal_chado.install.inc</code> file (<code class=\"language-text\">tripal/tripal_chado/includes/tripal_chado.install.inc</code>), which is currently on lines 221/244.</p>\n<p>Before</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">\n<span class=\"token variable\">$transaction</span> <span class=\"token operator\">=</span> <span class=\"token function\">db_transaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'Install Chado v1.3'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">tripal_chado_install_chado_1_3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">chado_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$vsql</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">':version'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'1.3'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'Upgrade Chado v1.2 to v1.3'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">tripal_chado_upgrade_chado_1_2_to_1_3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">chado_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$vusql</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">':version'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'1.3'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'Install Chado v1.2'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">tripal_chado_install_chado_1_2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">chado_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$vsql</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">':version'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'1.2'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'Upgrade Chado v1.11 to v1.2'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">tripal_chado_upgrade_chado_1_11_to_1_2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">chado_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$vsql</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">':version'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'1.2'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'Install Chado v1.11'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">tripal_chado_install_chado_1_11</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> <span class=\"token variable\">$e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token variable\">$transaction</span><span class=\"token operator\">-></span><span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">tripal_chado_install_done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">tripal_report_error</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'tripal_chado'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">TRIPAL_ERROR</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$e</span><span class=\"token operator\">-></span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'print'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">TRUE</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token constant boolean\">FALSE</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>After</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">\n<span class=\"token comment\">//$transaction = db_transaction();</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'Install Chado v1.3'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">tripal_chado_install_chado_1_3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">chado_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$vsql</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">':version'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'1.3'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'Upgrade Chado v1.2 to v1.3'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">tripal_chado_upgrade_chado_1_2_to_1_3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">chado_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$vusql</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">':version'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'1.3'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'Install Chado v1.2'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">tripal_chado_install_chado_1_2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">chado_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$vsql</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">':version'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'1.2'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'Upgrade Chado v1.11 to v1.2'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">tripal_chado_upgrade_chado_1_11_to_1_2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">chado_query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$vsql</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">':version'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'1.2'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$action</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'Install Chado v1.11'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">tripal_chado_install_chado_1_11</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> <span class=\"token variable\">$e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token comment\">//  $transaction->rollback();</span>\n  <span class=\"token function\">tripal_chado_install_done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">tripal_report_error</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'tripal_chado'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">TRIPAL_ERROR</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$e</span><span class=\"token operator\">-></span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'print'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">TRUE</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token constant boolean\">FALSE</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"Migrating from Chado 1.2 to 1.3"}}},"pageContext":{"slug":"/2019-03-19_migrating_chado_onetwo_to_onethree/"}},"staticQueryHashes":["2744294623","3649515864"],"slicesMap":{}}