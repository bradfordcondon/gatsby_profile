{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2018-09-24-tripal3_ajax_widgets/","result":{"data":{"markdownRemark":{"html":"<h1>Introduction</h1>\n<p>Link: <a href=\"https://github.com/tripal/tripal/issues/607\">original GitHub issue</a></p>\n<p>I found myself in a predicament: I wanted to include a dynamic element in my Tripal field's formatter.  </p>\n<p>However, I couldnt for the life of me get the AJAX callback to run in the formatter.</p>\n<h3>The problem: renderable arrays</h3>\n<p>Drupal has its special way of doing AJAX!  <a href=\"https://api.drupal.org/api/drupal/includes%21ajax.inc/group/ajax/7.x\">You should read the documentation carefully!</a>.  To Drupal, AJAX only makes sense as on forms.</p>\n<p>Here's the problem: formatters <strong>are not forms</strong>.  Instead, they are <a href=\"https://www.drupal.org/docs/7/api/render-arrays/render-arrays-overview\">renderable arrays</a>!  This is obvious in hindsight: rather than accepting <code class=\"language-text\">$form</code> and <code class=\"language-text\">&amp;$form_state</code>, they accept <code class=\"language-text\">&amp;$element, $entity_type, $entity, $langcode, $items, $display</code>, where <code class=\"language-text\">$element</code> is the renderable array.</p>\n<p>This means if we want to add an AJAX callback, we actually need a <strong>seperate form file</strong> tahts get added in using <code class=\"language-text\">drupal_get_form()</code>.  If we do this, we can build the AJAX as Drupal expects it.</p>\n<h3>the solution: <code class=\"language-text\">drupal_get_form</code></h3>\n<p>Here's my form file: as you can see its a standard form following Drupal AJAX conventions.  We provide a <code class=\"language-text\">rendered_maps</code> fieldset with the prefix defining the wrapper.  The selector has specifies that wrapper, and the AJAX callback function <code class=\"language-text\">tripalmap_organism_featuremap_callback</code>.  We then define that function to simply return  the piece of the form that should be rebuilt: the <code class=\"language-text\">rendered_maps</code> fieldset!</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function\">tripal_map_organism_featuremap_selector</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$form</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token variable\">$form_state</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$select</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token variable\">$selected</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$form_state</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'values'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'featuremap_select'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$selected</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$form_state</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'values'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'featuremap_select'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n\n  <span class=\"token variable\">$form</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'rendered_maps'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token single-quoted-string string\">'#type'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'fieldset'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token single-quoted-string string\">'#collapsible'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean constant\">FALSE</span><span class=\"token punctuation\">,</span>\n    <span class=\"token single-quoted-string string\">'#prefix'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'&lt;div id=\"tripalmap-featuremap-organism-selector-wrapper\">'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token single-quoted-string string\">'#suffix'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'&lt;/div>'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n\n  <span class=\"token variable\">$form</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'rendered_maps'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'featuremap_select'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token single-quoted-string string\">'#type'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'select'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token single-quoted-string string\">'#options'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token variable\">$select</span><span class=\"token punctuation\">,</span>\n    <span class=\"token single-quoted-string string\">'#title'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'Please select a map to view'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token single-quoted-string string\">'#default_value'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token variable\">$selected</span><span class=\"token punctuation\">,</span>\n    <span class=\"token single-quoted-string string\">'#ajax'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>\n      <span class=\"token single-quoted-string string\">'callback'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'tripalmap_organism_featuremap_callback'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token single-quoted-string string\">'wrapper'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'tripalmap-featuremap-organism-selector-wrapper'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token single-quoted-string string\">'effect'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'fade'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n\n  <span class=\"token variable\">$chosen</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$form_state</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'values'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'featuremap_select'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$chosen</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$form_state</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'input'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'featuremap_select'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$chosen</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\n    <span class=\"token variable\">$mini_form</span> <span class=\"token operator\">=</span> <span class=\"token function\">tripal_map_genetic_map_overview_form</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$form_state</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$chosen</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token variable\">$form</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'rendered_maps'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'map'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$mini_form</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token variable\">$form</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token variable\">$form</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * @param $form\n * @param $form_state\n *\n * @return mixed\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">tripalmap_organism_featuremap_callback</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$form</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span><span class=\"token variable\">$form_state</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token variable\">$form</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'rendered_maps'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In the field formatter, we simply add this form and put the markup in the element:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">      <span class=\"token comment\">//multiple maps for this organism, let user select.  Create a special form for that so we can have an AJAX select box</span>\n      <span class=\"token variable\">$select</span><span class=\"token operator\">=</span> <span class=\"token variable\">$select</span> <span class=\"token operator\">+</span> <span class=\"token variable\">$select_add</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token variable\">$form</span> <span class=\"token operator\">=</span> <span class=\"token function\">drupal_get_form</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'tripal_map_organism_featuremap_selector'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$select</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token variable\">$content</span> <span class=\"token operator\">=</span> <span class=\"token function\">drupal_render</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$form</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$element</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token single-quoted-string string\">'#type'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'markup'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token single-quoted-string string\">'#markup'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token variable\">$content</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$element</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"AJAX and widgets in Tripal 3"}}},"pageContext":{"slug":"/2018-09-24-tripal3_ajax_widgets/"}},"staticQueryHashes":["2744294623","3649515864"]}