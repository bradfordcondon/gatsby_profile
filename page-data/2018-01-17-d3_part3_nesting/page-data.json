{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/2018-01-17-d3_part3_nesting/","result":{"data":{"markdownRemark":{"html":"<p><img src=\"/img/d3/d3_logo.png\" alt=\"D3 logo\"></p>\n<p>In the <a href=\"/2017/12/31/d3_part2_flipping/\">previous post</a>, we learned about using scales to format our x and y axes, s well as our bar coloring.</p>\n<p>In this post I want to address how to <strong>nest</strong> data with D3.  We will use the nest method to automatically sort our samples by property, and we'll use multiple x-scales to group them along the x-axis.</p>\n<blockquote>\n<div id=\"plot_previous\"></div>\nOur graph at the end of the previous section.\n</blockquote>\n<blockquote>\n<div id=\"plot_previous_new_data\"></div>\nThis is the same plot-generating code, but we've added some more data to demonstrate grouping by property.\n</blockquote>\n<h2>Nesting</h2>\n<p>A common desire when laying out a plot is to have data grouped along the x-axis by some property.  We can accomplish this by <strong>nesting</strong> our data according to the property we would like to group by.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">\"one\"</span><span class=\"token punctuation\">,</span> property<span class=\"token operator\">:</span> <span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n             <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">\"two\"</span><span class=\"token punctuation\">,</span> property<span class=\"token operator\">:</span> <span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n             <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">\"two\"</span><span class=\"token punctuation\">,</span> property<span class=\"token operator\">:</span> <span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n             <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">\"four\"</span><span class=\"token punctuation\">,</span> property<span class=\"token operator\">:</span> <span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">57</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n             <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">\"five\"</span><span class=\"token punctuation\">,</span> property<span class=\"token operator\">:</span> <span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">17</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n             <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">\"six\"</span><span class=\"token punctuation\">,</span> property<span class=\"token operator\">:</span> <span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n             <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">\"seven\"</span><span class=\"token punctuation\">,</span> property<span class=\"token operator\">:</span> <span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">52</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n             <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">\"eight\"</span><span class=\"token punctuation\">,</span> property<span class=\"token operator\">:</span> <span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">11</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n             <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">\"nine\"</span><span class=\"token punctuation\">,</span> property<span class=\"token operator\">:</span> <span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">81</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n             <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">\"ten\"</span><span class=\"token punctuation\">,</span> property<span class=\"token operator\">:</span> <span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> <span class=\"token number\">62</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>     \n              <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>What does our nested output look like?  We can <code class=\"language-text\">console.log</code> the nested data to take a look.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">[</span>  <span class=\"token punctuation\">{</span> <span class=\"token string\">\"key\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span>\n     <span class=\"token string\">\"values\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span> <span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"one\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"property\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token number\">100</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">//...</span>\n    <span class=\"token comment\">// additional values removed for readability      </span>\n      <span class=\"token punctuation\">]</span>\n\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token string\">\"key\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"values\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span> <span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"three\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"property\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token number\">20</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> <span class=\"token string\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"four\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"property\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token number\">57</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">//...</span>\n      <span class=\"token comment\">// additional values removed for readability</span>\n     <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>As you can see, we now have an array of objects, where each object has two keys: a <code class=\"language-text\">key</code> that corresponds to the property name we nested by, and a <code class=\"language-text\">values</code> that holds an array of all the data matching that property.</p>\n<p>Now that our data is nested, how do we place it appropriately on our graph?  This is where <strong>Ordinal Scale Bands</strong> comes in.  Each property group will correspond to a single band, with individual samples distributed within it. </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> xScale <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span>scale<span class=\"token punctuation\">.</span><span class=\"token function\">ordinal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  xScale<span class=\"token punctuation\">.</span><span class=\"token function\">domain</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">entry</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> entry<span class=\"token punctuation\">.</span>key\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">rangeRoundBands</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> padding<span class=\"token punctuation\">,</span> outerPadding<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Our X-scale has two locations now: one for each of our two properties (\"a\" or \"b\").  Our next scale needs to map to <strong>within one of these domains</strong> based on the <strong>sample name</strong>.  Most of the examples I could find online use a uniform set of samples within each band: (<a href=\"https://bl.ocks.org/mbostock/3887051\">see here for an example</a>).  For some data this will be the case: each property group is made of male/female, or the same set of time points.  In our case, we don't know that the each sample won't appear in each group.  In fact, we don't even know if we have even property groups.  How can we deal with this?</p>\n<p>The solution I came up with is to build a scale index.  Each property group gets its <strong>own scale</strong> in addition to the main scale.  </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  x2Scales <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token comment\">//create a scale tracker</span>\n\n  <span class=\"token comment\">//go through the data and generated an individual scale for each group.</span>\n  data<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">propertyGroup</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    entriesInProperty <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    key               <span class=\"token operator\">=</span> propertyGroup<span class=\"token punctuation\">.</span>key\n    propertyGroup<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">entry</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      entriesInProperty<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    newScale      <span class=\"token operator\">=</span> d3<span class=\"token punctuation\">.</span>scale<span class=\"token punctuation\">.</span><span class=\"token function\">ordinal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">domain</span><span class=\"token punctuation\">(</span>entriesInProperty<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">rangeRoundPoints</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> xScale<span class=\"token punctuation\">.</span><span class=\"token function\">rangeBand</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    x2Scales<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> newScale\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>  Now our <code class=\"language-text\">x2Scales</code> object holds all the scales we need, index by the property group name.</p>\n<h3>Inputing nested data</h3>\n<p>Something you may find confusing is how to access our nested data.  We input our nested data the same way we do our unnested data: using the <code class=\"language-text\">selectAll(&#39;.newGroupClass&#39;).data(data).enter().append()</code> chain.  </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  <span class=\"token keyword\">var</span> barGroups <span class=\"token operator\">=</span> svg<span class=\"token punctuation\">.</span><span class=\"token function\">selectAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.barGroup'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">enter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'g'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'transform'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token string\">'translate('</span> <span class=\"token operator\">+</span> <span class=\"token function\">xScale</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">',0)'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>  </code></pre></div>\n<p>Where before the <code class=\"language-text\">d</code> object was the individual entry, now it's actually an object with a <code class=\"language-text\">key</code> and <code class=\"language-text\">values</code> index, with the entries we want to loop through under <code class=\"language-text\">values</code>.  How do we access them?  By performing <strong>another</strong> <code class=\"language-text\">selectAll().data().enter().append()</code> chain!  Rather than passing in a data object into the <code class=\"language-text\">.data()</code> call, we pass in a function that retrieves the entry!</p>\n<p>Once the data is entered, it's a matter of styling each bar in the bargroup: setting the height and fill, as before, but also transforming the x-value <strong>again</strong> to compensate for its locatio</p>\n<p>Notice that we use the <code class=\"language-text\">barGroups</code> variable we defined earlier, and then append <code class=\"language-text\">.bar</code> elements.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> bars <span class=\"token operator\">=</span> barGroups<span class=\"token punctuation\">.</span><span class=\"token function\">selectAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.bar'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> d<span class=\"token punctuation\">.</span>values\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">enter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">'rect'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fill'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">colorScale</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span>property<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'transform'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> scale <span class=\"token operator\">=</span> x2Scales<span class=\"token punctuation\">[</span>d<span class=\"token punctuation\">.</span>property<span class=\"token punctuation\">]</span><span class=\"token comment\">//fetch the scale</span>\n        <span class=\"token comment\">//shift this bar by its location in the scale</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">'translate('</span> <span class=\"token operator\">+</span>  <span class=\"token function\">scale</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">',0)'</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'y'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">yScale</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">style</span><span class=\"token punctuation\">(</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">d<span class=\"token punctuation\">,</span> i</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> height <span class=\"token operator\">-</span> <span class=\"token function\">yScale</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'width'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span></code></pre></div>\n<blockquote>\n<div id=\"plot_three\"></div>\nOur plot now separates samples into groups.\n</blockquote>\n<p>An interesting challenge is dealing with uneven groups.  With this approach, every group has the same bandwidth, and the spacing within groups are calculated for each one individually.  This can be result in tightly packed groups and dispersed groups in the same plot.  We can adjust the padding for each group based on the number of samples, but we're still left with unused space in our plot for smaller groups.  </p>","frontmatter":{"title":"D3 part three: Nesting"}}},"pageContext":{"slug":"/2018-01-17-d3_part3_nesting/"}},"staticQueryHashes":["2744294623","3649515864"]}