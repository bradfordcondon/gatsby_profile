{"data":{"markdownRemark":{"html":"<p>This miniature guide will walk us through adding Code Climate coverage reports.  I assume you are using the Tripal Test Suite helper to set up your Travis CI.</p>\n<p>The basic steps we will take:</p>\n<ul>\n<li>Enable Code Climate</li>\n<li>Generate coverage reports with Travis</li>\n<li>Configure Code Climate to receive reports</li>\n</ul>\n<blockquote>\n<p><img src=\"/img/file_by_file_code_coverage.png\" alt=\"File by file coverage\">\nCode coverage is a very rough metric of which files are well-tested.</p>\n</blockquote>\n<h3>Enable Code Climate</h3>\n<p>I use <a href=\"https://codeclimate.com/\">Code Climate</a> because its free for open source and it works with GitHub.  Feel free to use any platform you'd like.  Heres what we get with Code Climate:</p>\n<ul>\n<li>GitHub pull request checks reporting changes in code coverage</li>\n<li>File-by-file % test coverage</li>\n<li>Reports on test coverage over time</li>\n<li>Automated in-line suggestions on pull requests</li>\n<li>Code Sniffer integration (<a href=\"/2018-12-10-drupal_sniffing/\">see the guide I wrote on adding Drupal standard sniffing integration</a>)</li>\n</ul>\n<p>Once you've registered for <a href=\"https://codeclimate.com\">Code Climate</a>,visit <a href=\"https://codeclimate.com/oss/dashboard\">your dashboard</a> and click the \"add a new repo\" button.</p>\n<p>Once your repo is integrated, head to <strong>Repo Settings</strong> and click on <strong>Test coverage</strong>.  Here you'll find your TEST REPORTER ID which needs to be associated with the <code class=\"language-text\">CC_TEST_REPORTER_ID</code> environmental variable in your Travis environment.</p>\n<h3>Generate Code Coverage Reports in Travis</h3>\n<p>PHPUnit actually handles the code coverage report- if you want, you can run <code class=\"language-text\">./vendor/bin/phpunit --coverage-clover ./clover.xml</code> to create a <a href=\"https://www.atlassian.com/software/clover\">clover formatted report</a>, or, <code class=\"language-text\">phpunit  --coverage-html build/coverage-report</code> to build an html-formatted coverage report you can read!</p>\n<p>Prior to generating the report, we need to tell PHPUnit which files should be included in the report.  Adding the below <code class=\"language-text\">filter</code> tags to your <code class=\"language-text\">phpunit.xml</code> config file will tell PHPunit to report on all <code class=\"language-text\">.inc</code> and <code class=\"language-text\">.php</code> files in your <code class=\"language-text\">/includes</code> directory.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>phpunit</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>testsuites</span><span class=\"token punctuation\">></span></span>\n    ...\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>testsuites</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>filter</span><span class=\"token punctuation\">></span></span>\n   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>whitelist</span> <span class=\"token attr-name\">addUncoveredFilesFromWhitelist</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>directory</span> <span class=\"token attr-name\">suffix</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>.inc<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>./includes<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>directory</span><span class=\"token punctuation\">></span></span>\n     <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>directory</span> <span class=\"token attr-name\">suffix</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>.php<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>./includes<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>directory</span><span class=\"token punctuation\">></span></span>\n   <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>whitelist</span><span class=\"token punctuation\">></span></span>\n <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>filter</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>phpunit</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Note that the coverage report will only run when we add a <code class=\"language-text\">--coverage</code> flag: this intentional, to keep the unit tests we run on our development environment fest.</p>\n<p>Our <code class=\"language-text\">.travis.yml</code> file therefore needs to be updated (ill provide a complete example <code class=\"language-text\">.travis.yml</code> file at the end of this guide):</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> docker exec <span class=\"token punctuation\">-</span>it tripal bash <span class=\"token punctuation\">-</span>c \"cd /modules/tripal_eutils &amp;&amp; composer install &amp;&amp; DRUPAL_ROOT=/var/www/html IS_TRAVIS=TRUE ./vendor/bin/phpunit <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>coverage<span class=\"token punctuation\">-</span>clover ./clover.xml\"</code></pre></div>\n<p> Please read the <a href=\"https://phpunit.readthedocs.io/en/7.4/code-coverage-analysis.html\">PHPUnit documentation for more details</a>.</p>\n<h4>Adding Xdebug</h4>\n<p>Before we can generate the report in Travis, we need the Xdebug library installed.  The below line will install the xdebug library in our <code class=\"language-text\">tripal</code> container.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> docker exec <span class=\"token punctuation\">-</span>it tripal yum install <span class=\"token punctuation\">-</span>y php<span class=\"token punctuation\">-</span>pecl<span class=\"token punctuation\">-</span>xdebug.x86_64</code></pre></div>\n<h3>Send Reports to Code Climate</h3>\n<p>If we push our code to Travis, test should run with no problem, and the <code class=\"language-text\">clover.xml</code> report should be generated.  Its no good to us sitting there, though: next we need to send it to Code Climate.  Code Climate has <a href=\"https://docs.codeclimate.com/docs/configuring-test-coverage\">extensive documentation</a>, but I'll provide specific instructions for Tripal Test Suite users.</p>\n<h4>Add the reporter_id</h4>\n<p>When we set up Code Climate, we found our <code class=\"language-text\">CC_TEST_REPORTER_ID</code>.  Add it to the <code class=\"language-text\">env</code> section of your <code class=\"language-text\">.travis.yml</code></p>\n<h4>Run <code class=\"language-text\">test-reporter</code> before and after script</h4>\n<p>In the <code class=\"language-text\">before_script</code> seciton, we download the <code class=\"language-text\">cc-test-report</code> application and run the <code class=\"language-text\">before-build</code> program (I include teh <code class=\"language-text\">debug</code> flag which can be handy when setting up).</p>\n<p>I also map the Travis specific environmental git variables into generic ones that Code Climate expects.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> curl <span class=\"token punctuation\">-</span>L https<span class=\"token punctuation\">:</span>//codeclimate.com/downloads/test<span class=\"token punctuation\">-</span>reporter/test<span class=\"token punctuation\">-</span>reporter<span class=\"token punctuation\">-</span>latest<span class=\"token punctuation\">-</span>linux<span class=\"token punctuation\">-</span>amd64 <span class=\"token punctuation\">></span> ./cc<span class=\"token punctuation\">-</span>test<span class=\"token punctuation\">-</span>reporter\n<span class=\"token punctuation\">-</span> chmod +x ./cc<span class=\"token punctuation\">-</span>test<span class=\"token punctuation\">-</span>reporter\n<span class=\"token punctuation\">-</span> ./cc<span class=\"token punctuation\">-</span>test<span class=\"token punctuation\">-</span>reporter before<span class=\"token punctuation\">-</span>build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>debug\n<span class=\"token punctuation\">-</span> GIT_BRANCH=$TRAVIS_PULL_REQUEST_BRANCH\n<span class=\"token punctuation\">-</span> GIT_COMMIT_SHA=$TRAVIS_PULL_REQUEST_SHA</code></pre></div>\n<h4>After Script</h4>\n<p>Finally we need to do the after script processing.  This means calling  <code class=\"language-text\">./cc-test-reporter after-build</code> and providing the <code class=\"language-text\">clover.xml</code> report.  We additionally specify the <code class=\"language-text\">-p</code> parameter for the root path in the docker container where the tests/analysis took place (which is different from the Travis root).</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">after_script</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> ./cc<span class=\"token punctuation\">-</span>test<span class=\"token punctuation\">-</span>reporter after<span class=\"token punctuation\">-</span>build clover.xml <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>debug <span class=\"token punctuation\">-</span>t clover <span class=\"token punctuation\">-</span>p /var/www/html/sites/all/modules/custom/tripal_eutils <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>exit<span class=\"token punctuation\">-</span>code $TRAVIS_TEST_RESULT\n  <span class=\"token punctuation\">-</span></code></pre></div>\n<h3>All set!</h3>\n<p>The finished <code class=\"language-text\">.travis.yml</code> file is below.  Your coverage report should now appear in your code climate dashboard!  In addition, pull request checks will take place based on the criteria you set in <strong>Repo Settings</strong> area of Code Climate.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">language</span><span class=\"token punctuation\">:</span> php\n\n<span class=\"token key atrule\">php</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token number\">7.1</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> docker\n\n<span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> DRUPAL_ROOT=/var/www/html IS_TRAVIS=TRUE CC_TEST_REPORTER_ID=d4d6bcc22c56ae459a80bc9428eb44040b2e7225b45c79ac445343a73d582abf\n\n<span class=\"token key atrule\">before_script</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> docker pull statonlab/tripal3\n  <span class=\"token punctuation\">-</span> curl <span class=\"token punctuation\">-</span>L https<span class=\"token punctuation\">:</span>//codeclimate.com/downloads/test<span class=\"token punctuation\">-</span>reporter/test<span class=\"token punctuation\">-</span>reporter<span class=\"token punctuation\">-</span>latest<span class=\"token punctuation\">-</span>linux<span class=\"token punctuation\">-</span>amd64 <span class=\"token punctuation\">></span> ./cc<span class=\"token punctuation\">-</span>test<span class=\"token punctuation\">-</span>reporter\n  <span class=\"token punctuation\">-</span> chmod +x ./cc<span class=\"token punctuation\">-</span>test<span class=\"token punctuation\">-</span>reporter\n  <span class=\"token punctuation\">-</span> ./cc<span class=\"token punctuation\">-</span>test<span class=\"token punctuation\">-</span>reporter before<span class=\"token punctuation\">-</span>build <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>debug\n  <span class=\"token punctuation\">-</span> GIT_BRANCH=$TRAVIS_PULL_REQUEST_BRANCH\n  <span class=\"token punctuation\">-</span> GIT_COMMIT_SHA=$TRAVIS_PULL_REQUEST_SHA\n\n<span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> docker run <span class=\"token punctuation\">-</span>it <span class=\"token punctuation\">-</span>d <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>rm <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>name tripal <span class=\"token punctuation\">-</span>v \"$(pwd)\"<span class=\"token punctuation\">:</span>/modules/tripal_eutils statonlab/tripal3\n  <span class=\"token punctuation\">-</span> sleep 30 <span class=\"token comment\"># We pause here while postgres and apache boot</span>\n  <span class=\"token punctuation\">-</span> docker exec <span class=\"token punctuation\">-</span>it tripal bash <span class=\"token punctuation\">-</span>c \"cd /modules/ &amp;&amp; git clone https<span class=\"token punctuation\">:</span>//github.com/statonlab/tripal_manage_analyses.git &amp;&amp; drush pm<span class=\"token punctuation\">-</span>enable <span class=\"token punctuation\">-</span>y tripal_manage_analyses\"\n  <span class=\"token punctuation\">-</span> docker exec <span class=\"token punctuation\">-</span>it tripal drush pm<span class=\"token punctuation\">-</span>enable <span class=\"token punctuation\">-</span>y tripal_eutils\n  <span class=\"token punctuation\">-</span> docker exec <span class=\"token punctuation\">-</span>it tripal yum install <span class=\"token punctuation\">-</span>y php<span class=\"token punctuation\">-</span>pecl<span class=\"token punctuation\">-</span>xdebug.x86_64\n  <span class=\"token punctuation\">-</span> docker exec <span class=\"token punctuation\">-</span>it tripal bash <span class=\"token punctuation\">-</span>c \"cd /modules/tripal_eutils &amp;&amp; composer install &amp;&amp; DRUPAL_ROOT=/var/www/html IS_TRAVIS=TRUE ./vendor/bin/phpunit <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>coverage<span class=\"token punctuation\">-</span>clover ./clover.xml\"\n\n<span class=\"token key atrule\">after_script</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> ./cc<span class=\"token punctuation\">-</span>test<span class=\"token punctuation\">-</span>reporter after<span class=\"token punctuation\">-</span>build clover.xml <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>debug <span class=\"token punctuation\">-</span>t clover <span class=\"token punctuation\">-</span>p /var/www/html/sites/all/modules/custom/tripal_eutils <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>exit<span class=\"token punctuation\">-</span>code $TRAVIS_TEST_RESULT</code></pre></div>","frontmatter":{"title":"Code Coverage Reporting with Code Climate"}}},"pageContext":{"slug":"/2018-12-11-drupal_code_coverage/"}}